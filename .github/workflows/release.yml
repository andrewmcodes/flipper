name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # RubyGems trusted publishing (OIDC)
      contents: write   # Create GitHub Releases
    steps:
      - uses: actions/checkout@v6

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Build all gems
        run: |
          for gemspec in *.gemspec; do
            gem build "$gemspec"
          done
          mkdir -p pkg
          mv *.gem pkg/
          echo "Built gems:"
          ls -la pkg/

      - name: Configure RubyGems credentials
        uses: rubygems/configure-rubygems-credentials@v1.0.0

      - name: Publish all gems
        run: |
          # Push core gem first since other gems depend on it
          echo "Pushing flipper core gem..."
          gem push pkg/flipper-[0-9]*.gem || echo "Core gem already pushed, continuing..."

          for gem_file in pkg/flipper-*.gem; do
            basename="$(basename "$gem_file")"
            if [[ "$basename" =~ ^flipper-[0-9] ]]; then
              continue
            fi
            echo "Pushing $basename..."
            gem push "$gem_file" || echo "Failed to push $basename, continuing..."
          done

      - name: Create draft GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: pkg/*.gem
